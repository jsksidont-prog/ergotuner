<!--
Server (save as server.js) - DO NOT put your API key in frontend. Put it in an environment variable.

// server.js
const express = require('express');
const fetch = require('node-fetch');
require('dotenv').config();

const app = express();
app.use(express.json());

const OPENAI_KEY = process.env.OPENAI_API_KEY;
if (!OPENAI_KEY) {
  console.error('Missing OPENAI_API_KEY in environment');
  process.exit(1);
}

app.post('/api/chat', async (req, res) => {
  try {
    const { message, history } = req.body;
    const messages = [];
    if (Array.isArray(history)) messages.push(...history);
    messages.push({ role: 'user', content: message });

    const resp = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${OPENAI_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-3.5-turbo',
        messages,
        max_tokens: 800,
      }),
    });

    if (!resp.ok) {
      const errText = await resp.text();
      return res.status(resp.status).json({ error: errText });
    }

    const data = await resp.json();
    const assistantReply = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content || '';
    res.json({ reply: assistantReply });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: String(err) });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Server listening on ${PORT}`));

-->

<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HTML Chatbot - ErgoChat</title>
  <style>
    :root{font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{display:flex;flex-direction:column;align-items:center;gap:16px;padding:24px;background:#f6f8fb;color:#111}
    .chat{width:100%;max-width:720px;background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(20,20,40,0.06);padding:12px;display:flex;flex-direction:column;gap:12px}
    .messages{min-height:240px;max-height:60vh;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
    .msg{padding:10px 12px;border-radius:10px;max-width:78%}
    .user{align-self:flex-end;background:#e6f0ff}
    .bot{align-self:flex-start;background:#f2f3f7}
    .input-row{display:flex;gap:8px}
    textarea{flex:1;padding:10px;border-radius:8px;border:1px solid #e6e9ef;resize:vertical;min-height:48px}
    button{padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer}
    .small{font-size:12px;color:#666}
  </style>
</head>
<body>
  <h2>ErgoChat â€” Demo Chatbot (local)</h2>
  <div class="chat">
    <div class="messages" id="messages" aria-live="polite"></div>

    <div class="input-row">
      <textarea id="input" placeholder="Tulis pesan... (Enter kirim, Shift+Enter baris baru)"></textarea>
      <button id="send">Kirim</button>
    </div>
    <div class="small">Catatan: jangan simpan kunci API di file frontend. Jalankan server proxy yang tersedia di komentar atas.</div>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');

    let history = [
      { role: 'system', content: 'Kamu adalah asisten yang ramah dan membantu.' }
    ];

    function appendMessage(text, who){
      const div = document.createElement('div');
      div.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
      div.textContent = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function send(){
      const txt = inputEl.value.trim();
      if (!txt) return;
      appendMessage(txt, 'user');
      inputEl.value = '';

      // optimistic add a typing placeholder
      const loadingEl = document.createElement('div');
      loadingEl.className = 'msg bot';
      loadingEl.textContent = '...';
      messagesEl.appendChild(loadingEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      history.push({ role: 'user', content: txt });

      try{
        const resp = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: txt, history })
        });
        if (!resp.ok){
          const txtErr = await resp.text();
          loadingEl.textContent = 'Terjadi kesalahan: ' + txtErr;
          return;
        }
        const data = await resp.json();
        const reply = data.reply || '';
        history.push({ role: 'assistant', content: reply });
        loadingEl.textContent = reply;
      } catch(err){
        loadingEl.textContent = 'Terjadi kesalahan jaringan.';
        console.error(err);
      }
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    sendBtn.addEventListener('click', send);
    inputEl.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });
  </script>
</body>
</html>

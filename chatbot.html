<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERGO AI</title>
  <style>
    :root{
      --bg:#ffffff; --panel:#f6f8fc; --accent:#1a73e8; --text:#0b1220; --muted:#5f6b7a;
      --user:#e8f0fe; --bot:#ffffff; --ring:#e4e8ee; --overlay:rgba(0,0,0,.45);
      --hdr:60px; --tool:110px; 
    }
    *{box-sizing:border-box}
    html,body{ height:100%; max-width:100%; overflow:hidden; }
    body{ margin:0; background:var(--bg); color:var(--text);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
      padding-top:var(--hdr); }

    .hamburger-inline{
      position:fixed; top:12px; left:12px; z-index:1000;
      width:44px; height:44px; padding:0; display:inline-grid; place-items:center;
      border:1px solid var(--ring); border-radius:10px; background:#fff; color:var(--text); cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,.06); line-height:1; font-size:20px;
    }
    .hamburger-inline:active{ transform:scale(.98); }

    header.bar{
      position:fixed; top:0; left:0; right:0; z-index:900;
      height:var(--hdr); display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg,#fff,#fbfcff);
      border-bottom:1px solid var(--ring);
      padding:0 16px;
    }
    header.bar .title{ display:inline-flex; align-items:center; gap:10px; margin:0; font-size:18px; font-weight:800; letter-spacing:.3px; }
    header.bar .title img{ width:26px; height:26px; object-fit:contain; display:inline-block; }

    .drawer{position:fixed; inset:0; z-index:1000; display:none}
    .drawer.open{display:block}
    .drawer .overlay{position:absolute; inset:0; background:var(--overlay)}
    .drawer .panel{
      position:absolute; top:0; left:0; height:100dvh; width:320px; max-width:90vw;
      background:var(--panel); border-right:1px solid var(--ring);
      transform:translateX(-100%); transition:transform .25s ease;
      display:flex; flex-direction:column; box-shadow:0 8px 24px rgba(0,0,0,.08);
    }
    .drawer.open .panel{transform:translateX(0)}
    .panel header{position:sticky; top:0; border-bottom:1px solid var(--ring); padding:12px; background:var(--panel); z-index:1}
    .panel .content{padding:12px; overflow:auto; height:calc(100dvh - 56px)}
    .section-title{font-size:12px; color:var(--muted); margin:14px 0 6px}
    .row{display:flex; gap:10px; align-items:center}

    input, textarea, select, button:not(.hamburger-inline){
      width:100%; border:1px solid var(--ring); background:#fff; color:#0b1220; border-radius:10px; padding:10px 12px; outline:none;
    }
    textarea{min-height:80px; resize:vertical}
    button.primary{background:var(--accent); border:none; color:#fff; font-weight:600; cursor:pointer}
    button.ghost{background:#fff}
    .muted{font-size:12px; color:var(--muted)}

    main{ position:relative; height:100dvh; padding-bottom:var(--tool); }
    .chat{
      position:relative; height:calc(100dvh - var(--hdr)); padding:16px; padding-bottom:calc(var(--tool) + 16px);
      overflow:auto; scroll-behavior:smooth; display:flex; flex-direction:column; gap:14px; max-width:900px; width:100%; margin:0 auto; min-width:0;
    }
    @supports (height: 100svh){
      main{ height:100svh; }
      .chat{ height:calc(100svh - var(--hdr)); }
    }

    .bubble{ max-width:85%; padding:12px 14px; border-radius:16px;
      box-shadow:0 2px 12px rgba(0,0,0,.06); border:1px solid var(--ring);
      white-space:pre-wrap; position:relative; min-width:0; overflow-wrap:anywhere; background:var(--bot); }
    .me{align-self:flex-end; background:var(--user); color:#0b1220}
    .bot{align-self:flex-start; background:var(--bot)}
    .meta{font-size:12px; color:var(--muted); margin:2px 4px}

    .toolbar{
      position:fixed; bottom:0; left:0; right:0; z-index:950;
      display:grid; gap:10px; padding:10px 16px;
      background:var(--panel); border-top:1px solid var(--ring);
      padding-bottom:max(10px, env(safe-area-inset-bottom));
    }
    .grid-2{display:grid; grid-template-columns:1fr auto; gap:10px}
    .spinner{ width:18px; height:18px; border:2px solid var(--ring); border-top-color:var(--accent);
      border-radius:50%; animation:spin .9s linear infinite; display:inline-block; vertical-align:middle;}
    @keyframes spin{to{transform:rotate(360deg)}}

    .bot p{margin:0 0 8px}
    .bot pre{ overflow:auto; }

    #userInput{ max-height:35dvh; overflow:auto; resize:none; line-height:1.4; }

    .codebox{ position:relative; border:1px solid var(--ring); border-radius:12px; overflow:hidden; background:#0d1117; }
    .codebox-header{ display:flex; align-items:center; gap:10px; padding:8px 10px; font-size:12px; color:#c9d1d9;
      background:#0b0f14; border-bottom:1px solid #1f2937; }
    .codebox-lang{ opacity:.8; }
    .codebox pre{ margin:0; padding:12px 14px; }
    .codebox pre code{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color:#c9d1d9; }

    .code-copy{
      position:absolute; top:8px; right:10px; z-index:2; display:inline-flex; gap:6px;
      border:1px solid #2f3b4a; background:rgba(255,255,255,.06);
      color:#e5e7eb; padding:4px 8px; border-radius:8px; font-size:12px; cursor:pointer; backdrop-filter: blur(2px);
    }
    .code-copy:hover{ background:rgba(255,255,255,.12); }
    .code-copy svg{ width:14px; height:14px; }

    @media (max-width:640px){
      .bubble{max-width:92%}
      .grid-2{grid-template-columns:1fr}
      :root{ --tool:140px; }
    }

    .copy-actions{ display:flex; gap:8px; align-items:center; margin:6px 0 2px; max-width:85%; }
    .bot + .copy-actions{ align-self:flex-start; }
    .me  + .copy-actions{ align-self:flex-end; }
    .copy-btn{ border:1px solid var(--ring); background:#fff; color: var(--text); padding:6px 10px; border-radius:8px; font-size:12px; cursor:pointer; }
    .copy-btn:active{ transform:scale(.98); }
    @media (max-width:640px){ .copy-actions{ max-width:92%; } }
  </style>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/languages/python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/languages/javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/languages/typescript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/languages/go.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/languages/java.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/languages/cpp.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/languages/c.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/languages/ruby.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/languages/php.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/languages/rust.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/languages/kotlin.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/languages/swift.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/languages/shell.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/languages/sql.min.js"></script>
  <script>hljs.configure({ignoreUnescapedHTML:true});</script>
</head>
<body>
  <button id="hamburgerBtn" class="hamburger-inline" type="button" aria-label="Open menu">☰</button>

  <header class="bar">
    <h1 class="title" aria-label="Judul Aplikasi">
      <img src="ERGOPANTEK.png" alt="ERGOPANTEK" />
      <span>ERGO AI</span>
    </h1>
  </header>

  <!-- Drawer (pengaturan) -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="overlay" id="drawerOverlay"></div>
    <aside class="panel" role="dialog" aria-label="Settings">
      <header style="display:flex; align-items:center; gap:8px;">
        <div style="font-weight:700; flex:1">Menu</div>
        <button id="closeDrawerBtn" class="ghost" type="button" aria-label="Close menu">✕</button>
      </header>
      <div class="content">
        <div class="section-title">Navigasi</div>
        <div class="row">
          <button id="goHomeBtn" class="ghost" type="button">Home</button>
        </div>

        <!-- (tidak ada input API key) -->

        <div class="section-title">Model</div>
        <select id="model">
          <option value="gemini-2.5-flash">gemini-2.5-flash</option>
          <option value="gemini-1.5-flash-latest">gemini-1.5-flash-latest</option>
          <option value="gemini-1.5-pro-latest">gemini-1.5-pro-latest</option>
        </select>
        <div class="row" style="margin-top:8px">
          <button id="syncModelsBtn" class="ghost" type="button">Sync Models</button>
        </div>

        <div class="section-title">System Prompt</div>
        <textarea id="systemPrompt" placeholder="isi style / aturan tambahan di sini..."></textarea>
        <div class="row" style="margin-top:8px">
          <button id="applySysBtn" class="primary" type="button">Terapkan</button>
        </div>

        <div class="section-title">Percakapan</div>
        <div class="row">
          <button id="newChatBtn" class="ghost" type="button">New Chat</button>
        </div>
      </div>
    </aside>
  </div>

  <main>
    <div id="chat" class="chat"></div>
    <div class="toolbar">
      <div class="grid-2">
        <textarea id="userInput" placeholder="Tulis pesan "></textarea>
        <button id="sendBtn" class="primary" type="button">Kirim</button>
      </div>
    </div>
  </main>

  <script>
    const API_KEYS = [
      'AIzaSyBJT3isLdS_duk6jacH5x7bpxs-fiq8OGA',
      'AIzaSyAizWOJL82vxW-GkUlcA7W6WZ6opz9IZSU',
      'AIzaSyAuP8tHjFpDZdYH8eXf8rkQR1QhoVhP1hc',
      'AIzaSyA-KsZkA83F36UK1vXkTw6k85B0gg1k7wI',
      'AIzaSyBBaxMF2f0XBzULhQcbTM6JVyF-OLguwM8',
      'AIzaSyBa6Ei--12rN_MSgU7li80HGQ0wyd8ASVo',
      'AIzaSyD6fPFX_BBNbMzvcrgq_9XO8Q6Sx5_Js-o',
      'AIzaSyD2DeYkJY0goujHvSK93NgdSe9Y4J1zXfU',
      'AIzaSyCuOxHcIRIKTKj07zCx1nag4jgVF9XAjd0',
      'AIzaSyAJd0TpdhTHyfG4FvWMeKZB4jNoQp5gsXc'
    ];
    function pickKey(){ return API_KEYS[Math.floor(Math.random()*API_KEYS.length)]; }
    const BASE_SYS = 'kamu adalah Ergo ai';

    // ---------- State ----------
    const chatEl = document.getElementById('chat');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    // Drawer
    const drawer = document.getElementById('drawer');
    const drawerOverlay = document.getElementById('drawerOverlay');
    const openDrawerBtn = document.getElementById('hamburgerBtn');
    const closeDrawerBtn = document.getElementById('closeDrawerBtn');

    // Settings (tanpa API key)
    const modelSelect = document.getElementById('model');
    const syncBtn = document.getElementById('syncModelsBtn');
    const systemPromptEl = document.getElementById('systemPrompt');
    const applySysBtn = document.getElementById('applySysBtn');
    const newChatBtn = document.getElementById('newChatBtn');
    const goHomeBtn = document.getElementById('goHomeBtn');

    // localStorage keys (model & system prompt)
    const LS_MODEL = 'gemini_model';
    const LS_SYS   = 'gemini_system_prompt';

    const contents = [];

    // ---------- Drawer controls ----------
    function openDrawer(){ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); }
    function closeDrawer(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); }
    openDrawerBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); openDrawer(); });
    closeDrawerBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); closeDrawer(); });
    drawerOverlay.addEventListener('click', (e)=>{ if(e.target===drawerOverlay) closeDrawer(); });

    // ---------- Prefs ----------
    function loadPrefs(){
      const m = localStorage.getItem(LS_MODEL) || 'gemini-2.5-flash';
      const s = localStorage.getItem(LS_SYS) || '';
      modelSelect.value = m; systemPromptEl.value = s;
    }
    function savePrefs(){
      localStorage.setItem(LS_MODEL, modelSelect.value);
      localStorage.setItem(LS_SYS, systemPromptEl.value.trim());
      toast('Model & System Prompt disimpan.');
    }
    function toast(msg){ console.log(msg); }

    /* ============ Clipboard util ============ */
    async function copyToClipboard(text){
      try{
        if (navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(text); return true; }
      }catch(e){}
      try{
        const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.top='-9999px';
        ta.setAttribute('readonly',''); document.body.appendChild(ta); ta.select(); ta.setSelectionRange(0,ta.value.length);
        const ok=document.execCommand('copy'); document.body.removeChild(ta); if(ok) return true;
      }catch(e){}
      try{
        const sel=window.getSelection(); const range=document.createRange(); const div=document.createElement('div');
        div.textContent=text; div.style.position='fixed'; div.style.top='-9999px'; document.body.appendChild(div);
        range.selectNodeContents(div); sel.removeAllRanges(); sel.addRange(range);
        const ok=document.execCommand('copy'); sel.removeAllRanges(); document.body.removeChild(div); return !!ok;
      }catch(e){ return false; }
    }

    // ===== Markdown + Math + Code =====
    function renderRich(raw){
      if(!raw) return '';
      const codeHolders=[];
      raw = raw.replace(/```(\w+)?\n([\s\S]*?)```/g,(m,lang,code)=>{const i=codeHolders.push({lang:(lang||'').trim(),code})-1; return `@@CODE${i}@@`;});
      const mathDisplay=[], mathInline=[];
      raw = raw.replace(/\$\$([\s\S]+?)\$\$/g,(m,p1)=>{const i=mathDisplay.push(p1.trim())-1; return `@@MDIS${i}@@`;});
      raw = raw.replace(/\$(?!\$)([^\n]+?)\$(?!\$)/g,(m,p1)=>{const i=mathInline.push(p1.trim())-1; return `@@MINL${i}@@`;});
      raw = raw.replace(/@@CODE(\d+)@@/g,(m,i)=>`\n\n\`\`\`${codeHolders[+i].lang}\n${codeHolders[+i].code}\n\`\`\`\n\n`);
      marked.setOptions({breaks:true,gfm:true,highlight:(code,lang)=>{try{if(lang&&hljs.getLanguage(lang)) return hljs.highlight(code,{language:lang}).value;}catch{} return hljs.highlightAuto(code).value;}});
      let htmlMd = marked.parse(raw);
      htmlMd = htmlMd
        .replace(/@@MDIS(\d+)@@/g,(m,i)=>`<span class="math-display" data-idx="${i}"></span>`)
        .replace(/@@MINL(\d+)@@/g,(m,i)=>`<span class="math-inline" data-idx="${i}"></span>`);
      const clean = DOMPurify.sanitize(htmlMd,{ADD_ATTR:['data-idx']});
      const tpl = document.createElement('template'); tpl.innerHTML = clean;
      tpl.content.querySelectorAll('.math-display').forEach(el=>{ try{ katex.render(mathDisplay[+el.dataset.idx]||'', el, {displayMode:true, throwOnError:false}); }catch{} });
      tpl.content.querySelectorAll('.math-inline').forEach(el=>{ try{ katex.render(mathInline[+el.dataset.idx]||'', el, {displayMode:false, throwOnError:false}); }catch{} });
      return tpl.innerHTML;
    }

    function enhanceCodeBlocks(root){
      const blocks = [...root.querySelectorAll('pre > code')];
      for (const codeEl of blocks){
        const pre = codeEl.parentElement;
        if (pre.parentElement && pre.parentElement.classList.contains('codebox')) continue;
        try { hljs.highlightElement(codeEl); } catch{}
        const lang = ([...codeEl.classList].find(c => c.startsWith('language-')) || 'language-code').replace('language-','').toUpperCase();
        const wrap = document.createElement('div'); wrap.className='codebox';
        const header = document.createElement('div'); header.className='codebox-header'; header.textContent = lang;
        pre.replaceWith(wrap); wrap.appendChild(header); wrap.appendChild(pre);
        const copyBtn = document.createElement('button'); copyBtn.className='code-copy'; copyBtn.textContent='Salin kode';
        copyBtn.onclick = async ()=>{ try{ await navigator.clipboard.writeText(codeEl.innerText); copyBtn.textContent='Tersalin ✓'; setTimeout(()=>copyBtn.textContent='Salin kode',1100);}catch{copyBtn.textContent='Gagal'; setTimeout(()=>copyBtn.textContent='Salin kode',1100);} };
        wrap.appendChild(copyBtn);
      }
    }

    // ========== Chat bubble helpers ==========
    function attachCopyButton(bubbleEl){
      const row = document.createElement('div'); row.className = 'copy-actions';
      const btn = document.createElement('button'); btn.className = 'copy-btn'; btn.type = 'button'; btn.textContent = 'Salin';
      row.appendChild(btn); bubbleEl.insertAdjacentElement('afterend', row);
      btn.addEventListener('click', async (e)=>{ e.stopPropagation(); const ok = await copyToClipboard(bubbleEl.textContent.trim());
        const old = btn.textContent; btn.textContent = ok ? 'Tersalin ✓' : 'Gagal'; setTimeout(()=> btn.textContent = old, 1200); });
      row.scrollIntoView({ behavior:'smooth', block:'end' });
    }
    function addBubble(text, who){
      const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = who==='me' ? '' : 'ERGO AI';
      const b = document.createElement('div'); b.className = 'bubble ' + (who==='me' ? 'me' : 'bot');
      if(who==='me'){ b.textContent = text; } else { b.innerHTML = renderRich(text); enhanceCodeBlocks(b); }
      chatEl.appendChild(meta); chatEl.appendChild(b);
      if(who!=='me'){ attachCopyButton(b); } b.scrollIntoView({ behavior:'smooth', block:'end' });
    }
    function addTyping(){
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent='Ergo Ai sedang mengetik…';
      const b = document.createElement('div'); b.className='bubble bot'; b.id='typing'; b.innerHTML='<span class="spinner"></span> ';
      chatEl.appendChild(meta); chatEl.appendChild(b); b.scrollIntoView({ behavior:'smooth', block:'end' });
    }
    function removeTyping(){ const el=document.getElementById('typing'); if(el){ el.previousSibling?.remove(); el.remove(); } }

    // ---------- API Helpers (v1 → v1beta) ----------
    async function apiGet(path){
      // gunakan key acak juga untuk operasi "sync models"
      const KEY = pickKey();
      const versions=['v1','v1beta']; let lastErr;
      for(const v of versions){
        try{
          const url=`https://generativelanguage.googleapis.com/${v}/${path}${path.includes('?')?'&':'?'}key=${encodeURIComponent(KEY)}`;
          const res=await fetch(url); if(!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          return await res.json();
        }catch(e){ lastErr=e; }
      } throw lastErr;
    }
    async function apiPostGenerateContent(modelName, baseContents, sysText){
      // pilih 1 key RANDOM tiap kali kirim chat
      const KEY = pickKey();
      const versions = ['v1','v1beta']; let lastErr;
      const sysParts = [{ text: BASE_SYS }]; if (sysText && sysText.trim()) sysParts.push({ text: sysText.trim() });
      for(const v of versions){
        try{
          const url = `https://generativelanguage.googleapis.com/${v}/models/${encodeURIComponent(modelName)}:generateContent?key=${encodeURIComponent(KEY)}`;
          const body = { contents: baseContents.map(x=>x) };
          const sysObj = { parts: sysParts };
          if(v === 'v1'){ body.systemInstruction  = sysObj; } else { body.system_instruction = sysObj; }
          const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
          if(!res.ok){ throw new Error(`HTTP ${res.status}: ${await res.text()}`); }
          return await res.json();
        }catch(e){ lastErr = e; }
      }
      throw lastErr;
    }

    // ---------- Toolbar & Textarea sizing ----------
    const root = document.documentElement;
    const toolbar = document.querySelector('.toolbar');
    function syncToolHeight(){
      const h = toolbar.getBoundingClientRect().height;
      root.style.setProperty('--tool', h + 'px');
    }
    function autoGrow(){
      userInput.style.height = 'auto';
      const maxPx = Math.round(window.innerHeight * 0.35);
      userInput.style.height = Math.min(userInput.scrollHeight, maxPx) + 'px';
      syncToolHeight();
    }
    userInput.addEventListener('input', autoGrow);

    // ---------- Gemini call ----------
    function getModelName(){ return (localStorage.getItem(LS_MODEL) || modelSelect.value).trim(); }
    async function callGemini(prompt){
      const model = getModelName();
      const sysText = (localStorage.getItem(LS_SYS) || '').trim();
      const base = contents.concat([{ role:'user', parts:[{text: prompt}] }]);
      return apiPostGenerateContent(model, base, sysText);
    }

    // ---------- Sync models ----------
    async function syncModels(){
      try{
        const data = await apiGet('models');
        const list = (data.models||[]).filter(m=> (m?.supportedGenerationMethods||[]).includes('generateContent'));
        if(list.length){
          modelSelect.innerHTML='';
          list.sort((a,b)=>{
            const an=a.name||'', bn=b.name||'';
            const aVer=+(an.match(/(\d+\.\d+)/)?.[1] || 0), bVer=+(bn.match(/(\d+\.\d+)/)?.[1] || 0);
            if(bVer!==aVer) return bVer-aVer;
            const aLatest=an.includes('-latest')?1:0, bLatest=bn.includes('-latest')?1:0;
            if(bLatest!==aLatest) return bLatest-aLatest;
            return an.localeCompare(bn);
          });
          for(const m of list){
            const opt=document.createElement('option'); opt.value=m.name; opt.textContent=m.name; modelSelect.appendChild(opt);
          }
          localStorage.setItem(LS_MODEL, modelSelect.value);
          addBubble('Daftar model diperbarui. Dipilih: '+modelSelect.value,'bot');
        }else{
          addBubble('Tidak ada model yang mendukung generateContent dari ListModels.','bot');
        }
      }catch(e){ console.error(e); addBubble('Gagal mengambil daftar model: '+e.message,'bot'); }
    }

    async function send(){
      const text = userInput.value.trim(); if(!text) return;
      userInput.value=''; sendBtn.disabled=true; addBubble(text,'me'); addTyping();
      try{
        const json = await callGemini(text); removeTyping();
        const reply =
          (json?.candidates?.[0]?.content?.parts?.map(p=>p.text).join('\n')) ||
          (json?.candidates?.[0]?.content?.parts?.[0]?.text) ||
          '(tidak ada balasan)';
        addBubble(reply,'bot');
        contents.push({role:'user', parts:[{text:text}]});
        contents.push({role:'model', parts:[{text:reply}]});
      }catch(err){
        removeTyping();
        addBubble(`Gagal memanggil API: ${err.message}`,'bot');
        console.error(err);
      } finally {
        userInput.style.height = '';
        syncToolHeight();
        sendBtn.disabled=false; userInput.focus();
      }
    }

    function applySystemPrompt(){
      const s = systemPromptEl.value.trim();
      localStorage.setItem(LS_SYS, s);
      addBubble('System Prompt diterapkan' + (s ? '  “'+s+'”' : ''), 'bot');
    }
    function newChat(){ contents.splice(0, contents.length); chatEl.innerHTML=''; greeting(); }

    // ---------- Events ----------
    userInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});
    sendBtn.addEventListener('click', send);
    syncBtn.addEventListener('click', syncModels);
    applySysBtn.addEventListener('click', applySystemPrompt);
    newChatBtn.addEventListener('click', ()=>{ newChat(); closeDrawer(); });
    goHomeBtn.addEventListener('click', () => { closeDrawer(); window.location.href = 'index.html'; });

    function greeting(){ addBubble(`Halo ada yang ergo bisa bantu?`, 'bot'); }

    if (window.visualViewport) {
      const vv = window.visualViewport;
      function adjustForKeyboard(){
        const offset = Math.max(0, window.innerHeight - vv.height - vv.offsetTop);
        toolbar.style.bottom = offset + 'px';
      }
      vv.addEventListener('resize', () => { adjustForKeyboard(); syncToolHeight(); });
      vv.addEventListener('scroll',  () => { adjustForKeyboard(); });
      adjustForKeyboard();
    }

    function init(){
      loadPrefs(); greeting();
      syncToolHeight(); autoGrow();
      window.addEventListener('resize', syncToolHeight);
      enhanceCodeBlocks(document);
    }
    init();
  </script>
</body>
</html>
